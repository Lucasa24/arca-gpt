<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>üõ•Ô∏è A Arca - Ritual de Travessia üåä</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background-color: #0e0e0e;
      color: #f5f5f5;
      font-family: 'Georgia', serif;
      padding: 40px 1rem 300px;
      line-height: 1.6;
      max-width: 700px;
      width: 100%;
      margin: 0 auto;
      position: relative;
    }
    h1 {
      font-size: clamp(1.5rem, 5vw, 2.5rem);
      text-align: center;
      margin: 0 0 1.5rem 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #response {
      margin-top: 2rem;
      white-space: pre-wrap;
      background: #1c1c1c;
      padding: 1rem;
      border-left: 4px solid #b30000;
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
      text-align: justify;
      line-height: 1.8;
      letter-spacing: 0.5px;
    }

    .fixed-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #0e0e0e;
      padding: 0.5rem 1rem 0.75rem;
      border-top: 1px solid #333;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.4);
      font-size: 0.85rem;
      width: 100%;
      z-index: 100;
    }

    .input-group {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      max-width: 700px;
      width: 100%;
      margin: 0 auto;
    }

    textarea {
      flex: 1;
      background: #1a1a1a;
      color: #f5f5f5;
      border: 1px solid #333;
      padding: 0.5rem;
      font-size: 0.75rem;
      resize: none;
      height: 55px;
      font-family: 'Georgia', serif;
      width: 100%;
    }

    button {
      background-color: #b30000;
      color: #fff;
      border: none;
      font-size: 0.75rem;
      cursor: pointer;
      letter-spacing: 1px;
      padding: 0.5rem 1rem;
      height: 55px;
      min-width: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    button:hover {
      background-color: #ff1a1a;
    }

    #loader {
      height: 4px;
      margin-top: 0.25rem;
    }

    #loadingBar {
      height: 100%;
      background-color: #b30000;
      width: 0%;
      transition: width 0.3s ease-in-out;
    }

    .footer-note {
      font-size: 0.55rem;
      color: #555;
      margin-top: 0.25rem;
      text-align: center;
      opacity: 0.7;
    }
    /* Media Queries para responsividade */
    @media (max-width: 600px) {
      body {
        padding: 20px 0.75rem 250px;
      }
      
      h1 {
        font-size: clamp(1.2rem, 4vw, 1.8rem);
        margin-bottom: 1rem;
      }
      
      #response {
        padding: 0.75rem;
        margin-top: 1.5rem;
      }
      
      .fixed-footer {
        padding: 0.5rem 0.75rem;
      }
      
      button {
        padding: 0.5rem 0.75rem;
        min-width: 70px;
      }
      
      textarea {
        font-size: 0.7rem;
      }
    }
    
    @media (max-width: 400px) {
      body {
        padding: 15px 0.5rem 220px;
      }
      
      .input-group {
        gap: 0.3rem;
      }
      
      button {
        padding: 0.4rem 0.6rem;
        min-width: 60px;
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <h1>üõ•Ô∏è A Arca - Ritual de Travessia üåä</h1>
  <p>Digite sua invoca√ß√£o abaixo e sinta a resposta da Arca:</p>
  <div id="response"></div>

  <div class="fixed-footer">
    <div class="input-group">
      <textarea id="userInput" placeholder="Escreva com presen√ßa. Aqui n√£o h√° espa√ßo para palavras vazias."></textarea>
      <button onclick="sendMessage()">Invocar</button>
    </div>

    <div id="loader" style="display:none;">
      <div id="loadingBar"></div>
    </div>

    <p class="footer-note">Os dados fornecidos s√£o privados e protegidos!</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    // Fun√ß√£o para processar o texto e garantir que as palavras sejam separadas corretamente
    function formatText(text) {
      // Otimiza√ß√£o: verifica se o texto precisa ser processado
      if (!text || text.length < 15 || !/\w{15,}/.test(text)) {
        return text;
      }
      
      // Lista reduzida de palavras comuns em portugu√™s para usar como refer√™ncia
      const commonWords = ['a', 'o', 'e', 'de', 'da', 'do', 'em', 'no', 'na', 'para', 'por', 'com', 'sem', 'que', 'se', 'como', 'mas', 'ou', 'seu', 'sua', 'meu', 'minha', 'nosso', 'nossa', 'este', 'esta', 'esse', 'essa', 'aquele', 'aquela', 'quando', 'onde', 'quem', 'qual', 'quanto', 'porque', 'pois', 'ent√£o', 'assim', 'tamb√©m', 'muito', 'pouco', 'mais', 'menos', 'grande', 'pequeno', 'bom', 'bem', 'mal', 'melhor', 'pior', 'todo', 'toda', 'algum', 'alguma', 'nenhum', 'nenhuma', 'outro', 'outra', 'mesmo', 'mesma', 'cada', 'qualquer', 'v√°rios', 'v√°rias', 'alguns', 'algumas', 'todos', 'todas', 'entre', 'sobre', 'sob', 'ap√≥s', 'antes', 'depois', 'durante', 'desde', 'at√©', 'contra', 'segundo', 'conforme', 'atrav√©s', 'perante', 'mediante', 'exceto', 'salvo', 'sen√£o', 'enquanto', 'embora', 'portanto', 'contudo', 'todavia', 'entretanto', 'por√©m', 'logo', 'pois', 'ent√£o', 'por isso', 'assim', 'desse modo', 'dessa forma', 'por conseguinte', 'consequentemente', 'por exemplo', 'isto √©', 'ou seja', 'a saber', 'ali√°s', 'al√©m disso', 'inclusive', 'tamb√©m', 'ainda', 'n√£o', 'sim', 'talvez', 'certamente', 'provavelmente', 'possivelmente', 'realmente', 'verdadeiramente', 'felizmente', 'infelizmente'], 'med√≠ocre', 'excelente', 'comum', 'especial', 'vulgar', 'distinto', 'simples', 'complexo', 'f√°cil', 'dif√≠cil', 'complicado', 'descomplicado', 'intrincado', 'direto', 'confuso', 'claro', 'obscuro', 'evidente', 'amb√≠guo', 'expl√≠cito', 'impl√≠cito', 'definido', 'indefinido', 'preciso', 'vago', 'exato', 'aproximado', 'absoluto', 'relativo', 'concreto', 'abstrato', 'objetivo', 'subjetivo', 'real', 'imagin√°rio', 'verdadeiro', 'falso', 'aut√™ntico', 'fict√≠cio', 'genu√≠no', 'artificial', 'natural', 'sint√©tico', 'original', 'c√≥pia', 'prim√°rio', 'secund√°rio', 'principal', 'acess√≥rio', 'central', 'perif√©rico', 'essencial', 'acidental', 'intr√≠nseco', 'extr√≠nseco', 'inerente', 'adquirido', 'inato', 'aprendido', 'cong√™nito', 'desenvolvido', 'heredit√°rio', 'ambiental', 'gen√©tico', 'cultural', 'biol√≥gico', 'social', 'f√≠sico', 'mental', 'material', 'espiritual', 'corporal', 'ps√≠quico', 'tang√≠vel', 'intang√≠vel', 'concreto', 'abstrato', 'vis√≠vel', 'invis√≠vel', 'percept√≠vel', 'impercept√≠vel', 'sens√≠vel', 'insens√≠vel', 'aud√≠vel', 'inaud√≠vel', 'palp√°vel', 'impalp√°vel', 'mensur√°vel', 'imensur√°vel', 'quantific√°vel', 'inquantific√°vel', 'finito', 'infinito', 'limitado', 'ilimitado', 'restrito', 'irrestrito', 'condicionado', 'incondicionado', 'relativo', 'absoluto', 'parcial', 'total', 'fragmentado', 'integral', 'incompleto', 'completo', 'parcial', 'inteiro', 'fracionado', '√≠ntegro', 'dividido', 'unificado', 'separado', 'junto', 'isolado', 'conectado', 'independente', 'dependente', 'aut√¥nomo', 'subordinado', 'livre', 'condicionado', 'emancipado', 'subjugado', 'dominante', 'submisso', 'superior', 'inferior', 'privilegiado', 'desfavorecido', 'vantajoso', 'desvantajoso', 'beneficiado', 'prejudicado', 'favorecido', 'desfavorecido', 'afortunado', 'desafortunado', 'sortudo', 'azarado', 'feliz', 'infeliz', 'contente', 'descontente', 'satisfeito', 'insatisfeito', 'realizado', 'frustrado', 'pleno', 'vazio', 'completo', 'incompleto', 'cheio', 'vazio', 'abundante', 'escasso', 'farto', 'carente', 'rico', 'pobre', 'pr√≥spero', 'miser√°vel', 'opulento', 'indigente', 'abastado', 'necessitado', 'afluente', 'carente', 'privilegiado', 'desprivilegiado', 'afortunado', 'desafortunado', 'bem-sucedido', 'malsucedido', 'vitorioso', 'derrotado', 'triunfante', 'fracassado', 'vencedor', 'perdedor', 'campe√£o', 'derrotado', 'primeiro', '√∫ltimo', 'superior', 'inferior', 'melhor', 'pior', '√≥timo', 'p√©ssimo', 'excelente', 'terr√≠vel', 'excepcional', 'med√≠ocre', 'extraordin√°rio', 'ordin√°rio', 'not√°vel', 'comum', 'distinto', 'vulgar', 'especial', 'banal', '√∫nico', 'comum', 'singular', 'plural', 'individual', 'coletivo', 'pessoal', 'impessoal', 'particular', 'geral', 'espec√≠fico', 'gen√©rico', 'concreto', 'abstrato', 'definido', 'indefinido', 'determinado', 'indeterminado', 'certo', 'incerto', 'seguro', 'inseguro', 'est√°vel', 'inst√°vel', 'fixo', 'vari√°vel', 'constante', 'inconstante', 'permanente', 'tempor√°rio', 'duradouro', 'ef√™mero', 'eterno', 'transit√≥rio', 'perp√©tuo', 'moment√¢neo', 'infinito', 'finito', 'ilimitado', 'limitado', 'imenso', 'pequeno', 'vasto', 'restrito', 'amplo', 'estreito', 'extenso', 'reduzido', 'longo', 'curto', 'alto', 'baixo', 'profundo', 'raso', 'largo', 'estreito', 'grosso', 'fino', 'pesado', 'leve', 'denso', 'rarefeito', 'compacto', 'esparso', 'concentrado', 'dilu√≠do', 'espesso', 'fino', 'forte', 'fraco', 'intenso', 'suave', 'violento', 'moderado', 'extremo', 'm√©dio', 'radical', 'conservador', 'revolucion√°rio', 'tradicional', 'inovador', 'convencional', 'original', 'comum', 'incomum', 'normal', 'anormal', 'regular', 'irregular', 'padr√£o', 'at√≠pico', 't√≠pico', 'excepcional', 'usual', 'inusual', 'frequente', 'raro', 'comum', 'incomum', 'ordin√°rio', 'extraordin√°rio', 'banal', 'not√°vel', 'trivial', 'relevante', 'insignificante', 'importante'];
        
      // Fun√ß√£o para verificar se uma substring √© uma palavra comum
      function isCommonWord(word) {
        return commonWords.includes(word.toLowerCase());
      }
      
      // Fun√ß√£o para separar palavras longas usando um algoritmo mais robusto
      function separateWords(longText) {
        // Primeiro, tenta separar por padr√µes conhecidos
        let processedText = longText
          // Regras b√°sicas de separa√ß√£o
          .replace(/([a-zA-Z0-9])([A-Z])/g, '$1 $2') // camelCase
          .replace(/([.:;,?!])([a-zA-Z])/g, '$1 $2') // ap√≥s pontua√ß√£o
          .replace(/([a-zA-Z])([.:;,?!])/g, '$1$2 ') // pontua√ß√£o seguida de letra
          .replace(/([a-z√°√†√¢√£√©√®√™√≠√Ø√≥√¥√µ√∂√∫√ß√±])([A-Z√Å√Ä√Ç√É√â√à√ä√ç√è√ì√î√ï√ñ√ö√á√ë])/g, '$1 $2') // min√∫scula e mai√∫scula
          .replace(/([a-zA-Z])([0-9])/g, '$1 $2') // letra e n√∫mero
          .replace(/([0-9])([a-zA-Z])/g, '$1 $2'); // n√∫mero e letra
        
        // Se j√° conseguimos separar algumas palavras, retorna o texto com as separa√ß√µes feitas
        if (processedText.includes(' ')) {
          return processedText;
        }
        
        // Caso contr√°rio, tenta identificar palavras comuns
        let result = '';
        let currentWord = '';
        let i = 0;
        
        while (i < longText.length) {
          const char = longText[i];
          currentWord += char;
          i++;
          
          // Verifica se a palavra atual √© uma palavra comum
          if (currentWord.length >= 2) {
            let foundWord = false;
            
            // Tenta encontrar a maior palavra comum poss√≠vel
            for (let j = Math.min(currentWord.length, 10); j >= 2; j--) {
              const possibleWord = currentWord.substring(0, j);
              if (isCommonWord(possibleWord)) {
                result += possibleWord + ' ';
                currentWord = '';
                i--; // Volta um caractere para recome√ßar a an√°lise
                foundWord = true;
                break;
              }
            }
            
            // Se n√£o encontrou uma palavra comum e a palavra atual est√° ficando muito longa
            if (!foundWord && currentWord.length >= 8) {
              // Adiciona a palavra atual com um espa√ßo e recome√ßa
              result += currentWord + ' ';
              currentWord = '';
            }
          }
        }
        
        // Adiciona qualquer palavra restante
        if (currentWord.length > 0) {
          result += currentWord;
        }
        
        // Se ainda n√£o conseguimos separar bem, adiciona espa√ßos a cada 4-6 caracteres
        if (!result.includes(' ') || result.length > 20) {
          return longText.replace(/(.{4,6})(?=.)/g, '$1 ').trim();
        }
        
        return result.trim();
      }
      
      // Processa o texto em partes para evitar problemas de desempenho
      let processedText = text;
      
      // Aplica regras b√°sicas de separa√ß√£o em todo o texto
      processedText = processedText
        // Regras b√°sicas de separa√ß√£o
        .replace(/([a-zA-Z0-9])([A-Z])/g, '$1 $2') // Adiciona espa√ßo entre camelCase
        .replace(/([.:;,?!])([a-zA-Z])/g, '$1 $2') // Adiciona espa√ßo ap√≥s pontua√ß√£o
        .replace(/([a-zA-Z])([.:;,?!])/g, '$1$2 ') // Adiciona espa√ßo ap√≥s pontua√ß√£o seguida de letra
        
        // Regras espec√≠ficas para palavras coladas
        .replace(/([a-z√°√†√¢√£√©√®√™√≠√Ø√≥√¥√µ√∂√∫√ß√±])([A-Z√Å√Ä√Ç√É√â√à√ä√ç√è√ì√î√ï√ñ√ö√á√ë])/g, '$1 $2') // Adiciona espa√ßo entre min√∫scula e mai√∫scula
        .replace(/([a-zA-Z])([0-9])/g, '$1 $2') // Adiciona espa√ßo entre letra e n√∫mero
        .replace(/([0-9])([a-zA-Z])/g, '$1 $2'); // Adiciona espa√ßo entre n√∫mero e letra
      
      // Processa palavras muito longas (provavelmente concatenadas)
      processedText = processedText.replace(/\b(\w{15,})\b/g, function(match) {
        return separateWords(match);
      });
      
      // Adiciona espa√ßos a cada 4-6 caracteres em palavras longas mas n√£o t√£o longas
      processedText = processedText.replace(/\b(\w{10,14})\b/g, function(match) {
        // Verifica se a palavra parece ser uma concatena√ß√£o
        if (!/[aeiou√°√†√¢√£√©√®√™√≠√Ø√≥√¥√µ√∂√∫√ß]/i.test(match)) {
          // Se n√£o tiver vogais, provavelmente √© uma concatena√ß√£o ou c√≥digo
          return match.replace(/(.{4,6})(?=.)/g, '$1 ');
        }
        return match;
      });
      
      return processedText.trim();
    }
    
    async function sendMessage() {
      const input = document.getElementById("userInput").value.trim();
      const responseDiv = document.getElementById("response");
      const loader = document.getElementById("loader");
      const loadingBar = document.getElementById("loadingBar");

      if (!input) {
        responseDiv.innerHTML = "‚ö†Ô∏è Nada foi invocado.";
        return;
      }

      responseDiv.innerHTML = "Invocando...";
      loader.style.display = "block";
      loadingBar.style.width = "0%";

      let progress = 0;
      const interval = setInterval(() => {
        if (progress < 95) {
          progress += 1;
          loadingBar.style.width = progress + "%";
        }
      }, 30);

      try {
        const response = await fetch("/api/arca", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ input })
        });

        if (!response.ok) throw new Error("Falha ao invocar: " + response.statusText);

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buffer = "";
        let fullText = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const parts = buffer.split("\n\n");
          buffer = parts.pop();

          for (let part of parts) {
            if (!part.startsWith("data: ")) continue;

            const content = part.replace("data: ", "").trim();
            if (content === "[DONE]") {
              clearInterval(interval);
              loader.style.display = "none";
              loadingBar.style.width = "100%";
              // Aplica formata√ß√£o final ao texto completo
              const formattedText = formatText(fullText.trim());
              responseDiv.innerHTML = marked.parse(formattedText);
              return;
            }

            fullText += content;
            // Formata o texto para exibi√ß√£o enquanto est√° sendo recebido
            const formattedText = formatText(fullText.trim());
            responseDiv.innerHTML = marked.parse(formattedText);
          }
        }
      } catch (err) {
        clearInterval(interval);
        loader.style.display = "none";
        responseDiv.innerHTML = "‚ö†Ô∏è A Arca silenciou: " + err.message;
      }
    }

    window.sendMessage = sendMessage;
  </script>
</body>
</html>
