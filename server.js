// Carregar dotenv apenas em desenvolvimento local
if (process.env.NODE_ENV !== 'production') {
  require('dotenv').config();
}

const http = require('http');
const fs = require('fs');
const path = require('path');

const server = http.createServer((req, res) => {
  if (req.method === 'GET' && req.url === '/') {
    // Servir o index.html
    fs.readFile(path.join(__dirname, 'index.html'), (err, data) => {
      if (err) {
        res.writeHead(500);
        res.end('Erro interno do servidor');
        return;
      }
      res.writeHead(200, { 'Content-Type': 'text/html' });
      res.end(data);
    });
  } else if (req.method === 'GET' && req.url === '/favicon.ico') {
    // Servir o favicon
    fs.readFile(path.join(__dirname, 'favicon.ico'), (err, data) => {
      if (err) {
        res.writeHead(404);
        res.end('Not found');
        return;
      }
      res.writeHead(200, { 'Content-Type': 'image/x-icon' });
      res.end(data);
    });
  } else if (req.method === 'POST' && req.url === '/api/thread') {
    // Mock da API de thread
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ threadId: 'thread_' + Date.now() }));
  } else if (req.method === 'POST' && req.url === '/api/arca') {
    // Mock da API da Arca
    let body = '';
    req.on('data', chunk => {
      body += chunk.toString();
    });
    req.on('end', () => {
      const { input } = JSON.parse(body);
      
      res.writeHead(200, {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive'
      });
      
      // Simular resposta streaming
      const response = `üåä **Resposta da Arca para:** "${input}"\n\nA Arca ecoa suas palavras atrav√©s das √°guas m√≠sticas. Esta √© uma resposta de teste para demonstrar as funcionalidades implementadas:\n\n- ‚úÖ **Confirma√ß√£o no Reset**: Agora voc√™ precisa confirmar antes de perder a conversa\n- ‚úÖ **Sidebar de Sess√µes**: Lista lateral com hist√≥rico de conversas\n- ‚úÖ **Nova Travessia**: Bot√£o para iniciar nova sess√£o\n- ‚úÖ **Navega√ß√£o entre Threads**: Clique nas sess√µes para alternar\n\n*As √°guas da mem√≥ria agora fluem de forma organizada...*`;
      
      const words = response.split(' ');
      let index = 0;
      
      const interval = setInterval(() => {
        if (index < words.length) {
          res.write(`data: ${words[index]} `);
          index++;
        } else {
          res.write('data: [DONE]');
          res.end();
          clearInterval(interval);
        }
      }, 100);
    });
  } else {
    res.writeHead(404);
    res.end('Not found');
  }
});

const PORT = process.env.PORT || 3000;

// Para desenvolvimento local
if (process.env.NODE_ENV !== 'production') {
  server.listen(PORT, () => {
    console.log(`üõ•Ô∏è Servidor da Arca rodando em http://localhost:${PORT}`);
  });
}

// Export para Vercel
module.exports = server;
